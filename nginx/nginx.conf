user nginx; #defines the user 
worker_processes auto; #recommended to set to the number of cpus on the machine you can check using 'cat /proc/cpuinfo'

error_log /var/log/nginx/error.log warn; #defines where the error logs will be kept & setting log level to warn
pid /var/run/nginx.pid; #defines where the pid file will be located

events {
    worker_connections 1024; #leave default
}

http {

    log_format interceptor 'Intercepted $remote_addr trying to access $uri via HTTP'; #define a log format called interceptor for logging interceptions
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    ############################################################
    # HTTPS Server Block (Port 443)
    ############################################################
    server {
        listen 443 ssl; #listens on port 433 | https
        server_name treq.test;
        keepalive_timeout 70;

        # Using absolute paths as theyâ€™ll be inside the container later
        ssl_certificate     /etc/nginx/ssl/treq.crt;
        ssl_certificate_key /etc/nginx/ssl/treq.key;
        ssl_dhparam         /etc/nginx/dhparam.pem;

        # Public static routes
        location / {
            alias /usr/share/nginx/html/;
            index index.html;
        }

        location /public/ {
            alias /usr/share/nginx/html/public/;
            index public.html;
        }

        # Admin Panel
        location /admin/ {
            alias /usr/share/nginx/html/admin/;
            index admin.html;
        }

        # Files (general + specific nested folders)
        location /files/ {
            alias /usr/share/nginx/html/files/;
            autoindex on;
        }

        location /files/runner/ {
            alias /usr/share/nginx/html/files/runner/;
            index runner.html;
        }

        # More Files
        location /morefiles/ {
            alias /usr/share/nginx/html/morefiles/;
            autoindex on;
        }

        location /morefiles/asphalt/ {
            alias /usr/share/nginx/html/morefiles/asphalt/;
            index asphalt.html;
        }

        location /morefiles/mostlynormal/ {
            alias /usr/share/nginx/html/morefiles/mostlynormal/;
            index mostlynormal.html;
        }
    }

    ############################################################
    # HTTP Server Block (Port 80)
    ############################################################
    server {
        listen 80; # http server | listening on port 80
        server_name treq.test;

        access_log /var/log/nginx/http_intercept.log interceptor; #log every access in the http_intercept.log file

        # Redirect all other HTTP routes to HTTPS by default
        location / {
            return 301 https://$host$request_uri;
        }

        # Public route (allowed on HTTP)
        location /public/ {
            alias /usr/share/nginx/html/public/;
            index public.html;
        }
        location /files/ {
            alias /usr/share/nginx/html/files/;
            autoindex on;
        }

        # Explicitly blocked routes (only HTTPS allowed)
        location /morefiles/ {
            return 301 https://$host$request_uri; #auto redirection to https
        }

        location /admin/ {
            error_page 403 /403.html;
            return 403;
        }

        location /asphalt/ {
            error_page 403 /403.html;
            return 403;
        }

        location /mostlynormal/ {
            error_page 403 /403.html;
            return 403;
        }

        # Log
        location /logs {
            alias /usr/share/nginx/html/;
            index logs.txt;
        }

        # Custom 403 error page
        location = /403.html {
            root /usr/share/nginx/html;
        }
    }

}
